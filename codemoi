import pandas as pd
import numpy as np
import os
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.linear_model import LogisticRegression
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import accuracy_score

# --- Cáº¤U HÃŒNH ---
FILE_PATH = 'hanoi-aqi-weather-data.csv'

# CÃ i Ä‘áº·t hiá»ƒn thá»‹
sns.set(style="whitegrid")
plt.rcParams['figure.figsize'] = (14, 8)


# --- MODULE TÃNH TOÃN AQI (Dá»±a trÃªn ná»“ng Ä‘á»™ PM2.5) ---
def calc_aqi_pm25(pm25):
    """
    TÃ­nh chá»‰ sá»‘ AQI dá»±a trÃªn ná»“ng Ä‘á»™ PM2.5 (Âµg/mÂ³) theo cÃ´ng thá»©c chuáº©n EPA.
    """
    if pd.isna(pm25): return 0
    c = float(pm25)

    if c <= 12.0:
        return ((50 - 0) / (12.0 - 0)) * (c - 0) + 0
    elif c <= 35.4:
        return ((100 - 51) / (35.4 - 12.1)) * (c - 12.1) + 51
    elif c <= 55.4:
        return ((150 - 101) / (55.4 - 35.5)) * (c - 35.5) + 101
    elif c <= 150.4:
        return ((200 - 151) / (150.4 - 55.5)) * (c - 55.5) + 151
    elif c <= 250.4:
        return ((300 - 201) / (250.4 - 150.5)) * (c - 150.5) + 201
    elif c <= 350.4:
        return ((400 - 301) / (350.4 - 250.5)) * (c - 250.5) + 301
    else:
        return ((500 - 401) / (500.4 - 350.5)) * (c - 350.5) + 401


def phan_loai_aqi_vn(aqi):
    """PhÃ¢n loáº¡i nhÃ£n AQI cho mÃ´ hÃ¬nh há»c mÃ¡y"""
    if aqi <= 50:
        return 0
    elif aqi <= 100:
        return 1
    elif aqi <= 150:
        return 2
    elif aqi <= 200:
        return 3
    else:
        return 4


def run_analysis():
    print("--- 1. Äá»ŒC Dá»® LIá»†U & TÃNH TOÃN AQI ---")
    if not os.path.exists(FILE_PATH):
        print(f"âŒ Lá»–I: KhÃ´ng tÃ¬m tháº¥y file '{FILE_PATH}'!")
        return

    df = pd.read_csv(FILE_PATH)
    df.columns = [c.lower().replace('.', '').strip() for c in df.columns]

    if 'pm25' not in df.columns:
        print("âŒ Lá»–I: Dataset khÃ´ng cÃ³ cá»™t 'pm25' Ä‘á»ƒ tÃ­nh AQI.")
        return

    print(">>> Äang tÃ­nh toÃ¡n chá»‰ sá»‘ AQI tá»« ná»“ng Ä‘á»™ bá»¥i PM2.5...")
    df['calculated_aqi'] = df['pm25'].apply(calc_aqi_pm25)

    # Táº¡o biáº¿n má»¥c tiÃªu (Target) vÃ  biáº¿n Ä‘áº§u vÃ o (X)
    y = df['calculated_aqi'].apply(phan_loai_aqi_vn)
    X_raw = df.select_dtypes(include=[np.number])

    # Loáº¡i bá» cá»™t AQI vá»«a tÃ­nh ra khá»i Ä‘áº§u vÃ o X Ä‘á»ƒ trÃ¡nh data leakage
    if 'calculated_aqi' in X_raw.columns:
        X = X_raw.drop(columns=['calculated_aqi'])
    else:
        X = X_raw

    feature_names = X.columns.tolist()
    print(f"âœ… Dá»¯ liá»‡u sáºµn sÃ ng: {X.shape[0]} dÃ²ng, {X.shape[1]} biáº¿n.")

    # --- 2. HUáº¤N LUYá»†N MÃ” HÃŒNH ---
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(X)
    X_train, X_test, y_train, y_test = train_test_split(X_scaled, y, test_size=0.2, random_state=42)

    print("--- 2. ÄANG CHáº Y LOGISTIC REGRESSION Äá»‚ TÃŒM TRá»ŒNG Sá» ---")
    model = LogisticRegression(solver='lbfgs', max_iter=5000)
    model.fit(X_train, y_train)

    acc = accuracy_score(y_test, model.predict(X_test))
    print(f"\nğŸ“Š Äá»˜ CHÃNH XÃC MÃ” HÃŒNH: {acc * 100:.2f}%")

    # --- 3. PHÃ‚N TÃCH & Váº¼ BIá»‚U Äá»’ ---
    importance = np.mean(np.abs(model.coef_), axis=0)
    feat_imp = pd.DataFrame({'Feature': feature_names, 'Importance': importance})
    feat_imp = feat_imp.sort_values(by='Importance', ascending=False)

    plt.figure(figsize=(12, 7))

    colors = ['#9b59b6' if i == 0 else '#27ae60' for i in range(len(feat_imp))]

    # Váº½ biá»ƒu Ä‘á»“ (ÄÃ£ sá»­a lá»—i Future Warning cá»§a Seaborn)
    sns.barplot(x='Importance', y='Feature', data=feat_imp, hue='Feature', palette=colors, legend=False)

    plt.title('PHÃ‚N TÃCH TÃC Äá»˜NG: Yáº¾U Tá» NÃ€O Cáº¤U THÃ€NH NÃŠN Ã” NHIá»„M (AQI)?', fontsize=16, fontweight='bold')
    plt.xlabel('Trá»ng sá»‘ áº£nh hÆ°á»Ÿng (Feature Importance)', fontsize=12)
    plt.ylabel('CÃ¡c chá»‰ sá»‘ mÃ´i trÆ°á»ng', fontsize=12)

    # Hiá»ƒn thá»‹ giÃ¡ trá»‹ lÃªn tá»«ng thanh
    for index, value in enumerate(feat_imp['Importance']):
        plt.text(value, index, f' {value:.2f}', va='center', fontweight='bold')

    plt.tight_layout()
    plt.show()


if __name__ == "__main__":
    run_analysis()

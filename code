import pandas as pd
import numpy as np
import os
import matplotlib.pyplot as plt
from sklearn.cluster import KMeans
from sklearn.decomposition import PCA
from sklearn.preprocessing import StandardScaler
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.neural_network import MLPClassifier
from sklearn.metrics import accuracy_score

file_name = 'hanoi-aqi-weather-data.csv'

if not os.path.exists(file_name):
    print(f"LỖI: Không tìm thấy file '{file_name}'. Hãy kiểm tra lại!")
else:
    print("--- 1. Đang đọc dữ liệu môi trường Hà Nội... ---")
    df = pd.read_csv(file_name)
    
    # Lấy các chỉ số đo đạc thực tế (CO, NO2, PM2.5, Nhiệt độ...)
    # Bỏ qua các cột chữ (Tên thành phố, Múi giờ...)
    X_original = df.select_dtypes(include=[np.number]).dropna()
    print(f"Dữ liệu gốc: {X_original.shape[0]} dòng, {X_original.shape[1]} chỉ số môi trường.")

    # 2. PHÂN LOẠI TRẠNG THÁI Ô NHIỄM (K-MEANS)
    # Dùng K-means để chia ra 25 kiểu thời tiết/ô nhiễm khác nhau
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(X_original)

    print("--- 2. Đang phân loại 25 hình thái ô nhiễm (Clustering)... ---")
    kmeans = KMeans(n_clusters=25, n_init=10, random_state=42)
    y_labels = kmeans.fit_predict(X_scaled)

    # 3. GIẢM CHIỀU (PCA) & SO SÁNH MODEL
    # Vì chỉ có ~14 biến --> Thử nén xuống mức tối thiểu (ví dụ: 5-8 chiều)
    # xem máy có còn nhận diện được ô nhiễm không.
    print("--- 3. Thực hiện PCA và So sánh Linear Regression vs MLP... ---")
    
    # Giả sử muốn nén xuống còn 8 thành phần chính (Principal Components)
    n_comp = 8 
    pca = PCA(n_components=n_comp)
    X_pca = pca.fit_transform(X_scaled)
    
    # Chia tập Train/Test
    X_train, X_test, y_train, y_test = train_test_split(X_pca, y_labels, test_size=0.2, random_state=42)

    # MÔ HÌNH 1: LINEAR REGRESSION (Cơ bản)
    lr = LinearRegression()
    lr.fit(X_train, y_train)
    # Làm tròn kết quả vì Linear Regression trả về số thực
    y_pred_lr = np.round(lr.predict(X_test)).clip(0, 24)
    acc_lr = accuracy_score(y_test, y_pred_lr)

    # MÔ HÌNH 2: MLP CLASSIFIER (Nâng cao)
    mlp = MLPClassifier(hidden_layer_sizes=(100, 50), max_iter=2000, random_state=42)
    mlp.fit(X_train, y_train)
    acc_mlp = accuracy_score(y_test, mlp.predict(X_test))

    # 4. KẾT QUẢ VÀ TRỰC QUAN HÓA
    print("\n" + "="*50)
    print("BÁO CÁO KẾT QUẢ THỰC NGHIỆM")
    print("="*50)
    print(f"Số biến đầu vào: {X_original.shape[1]} (Gồm: {list(X_original.columns[:5])}...)")
    print(f"Số chiều sau khi nén PCA: {n_comp}")
    print("-" * 50)
    print(f"1. Độ chính xác Linear Regression: {acc_lr*100:.2f}%")
    print(f"2. Độ chính xác MLP (Neural Net):  {acc_mlp*100:.2f}%")
    print("="*50)

    # Vẽ biểu đồ mức độ quan trọng của các yếu tố môi trường
    # Xem biến nào đóng góp nhiều nhất vào thành phần chính đầu tiên
    feature_names = X_original.columns
    loadings = np.abs(pca.components_[0])
    
    # Sắp xếp để vẽ đẹp hơn
    sorted_idx = np.argsort(loadings)
    plt.figure(figsize=(10, 6))
    plt.barh(feature_names[sorted_idx], loadings[sorted_idx], color='teal')
    plt.title("Mức độ ảnh hưởng của các chỉ số đến phân loại ô nhiễm (PCA)")
    plt.xlabel("Trọng số đóng góp (Importance)")
    plt.show()
